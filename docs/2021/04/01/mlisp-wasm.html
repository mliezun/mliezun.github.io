<!DOCTYPE HTML/><html lang="en-US"><head><script type="text/javascript">if (window.location.host === 'mliezun.github.io') {
                    window.location.host = 'mliezun.com';
                }
</script><meta charset="UTF-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Mlisp: My own lisp implementation compiled to WASM</title><meta name="generator" content="Custom"/><meta property="og:title" content="Mlisp: My own lisp implementation compiled to WASM"/><meta property="og:locale" content="en_US"/><meta name="description" content="Lisp implementation written in C that compiles to WASM with emscripten."/><meta property="og:description" content="Lisp implementation written in C that compiles to WASM with emscripten."/><meta name="keywords" content="lisp,wasm,emcc,C/C++,emscripten"/><link rel="canonical" href="https://mliezun.com/2021/04/01/mlisp-wasm.html"/><meta property="og:url" content="https://mliezun.com/2021/04/01/mlisp-wasm.html"/><meta property="og:site_name" content="mliezun.com"/><meta property="og:image" content="https://mliezun.com/assets/images/nyc.jpg"/><link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico"/><meta property="og:type" content="article"/><meta name="twitter:card" content="summary"/><meta property="twitter:title" content="Mlisp: My own lisp implementation compiled to WASM"/><meta name="twitter:creator" content="@migueliezun"/><meta name="twitter:image" content="https://mliezun.com/assets/images/nyc.jpg"/>
<script type="application/ld+json">{"description":"Lisp implementation written in C that compiles to WASM with emscripten.","author":{"@type":"Person","name":"Miguel Liezun"},"@type":"BlogPosting","url":"https://mliezun.com/2021/04/01/mlisp-wasm.html","headline":"Mlisp: My own lisp implementation compiled to WASM","dateModified":"2021-04-01T00:00:00-03:00","datePublished":"2021-04-01T00:00:00-03:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mliezun.com/2021/04/01/mlisp-wasm.html"},"@context":"https://schema.org"}
</script><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"/><link rel="stylesheet" href="/assets/css/style.css"/></head><body><div class="body-wrapper"><div class="body-content"><div class="site-header"><header><a href="/" style="text-decoration: none !important">Miguel's dev blog</a></header><button class="theme-toggle" id="theme-toggle" title="Toggle theme"><img src="/assets/images/circle-half.svg"/></button></div><hr/><article><div>

</div><h2>Mlisp, My own lisp implementation
</h2><div>
<a href="https://github.com/mliezun/mlisp">Mlisp</a> a tiny lispy language based on the book <a href="http://www.buildyourownlisp.com/">Build Your Own Lisp</a>.

The interpreter is written in C and compiled directly to WASM. You can try it in this page by openning the developer console of your browser and typing <span class="single-quote">Mlisp.interpret("+ 2 2")</span> or using the repl shown below.


</div><h3>Interface
</h3><div>
To be able to access C functions from your browser you have to export them. Let's see how we can define a function that is exported.

<pre class="triple-quote c">
#if __EMSCRIPTEN__
EMSCRIPTEN_KEEPALIVE
#endif
int mlisp_init();
</pre>

When compilen with <span class="single-quote">emcc</span> the emscripten compiler to wasm, you have to add <span class="single-quote">EMSCRIPTEN_KEEPALIVE</span> macro before your function so it doesn't get optimized away.

The exported functions in this project are:

<pre class="triple-quote c">
int mlisp_init();
char *mlisp_interpret(char *input);
void mlisp_cleanup();
</pre>

The project is then compiled with: 

<pre class="triple-quote ">
emcc -std=c99  -Wall -O3 -s WASM=1 -s EXTRA_EXPORTED_RUNTIME_METHODS='["cwrap"]'
</pre>

That means that you would be able to access the exported functions using a <span class="single-quote">cwrap</span> that let's you wrap a C function call from a Javascript function call.

This compilation generates two files <span class="single-quote">mlisp.js</span> and <span class="single-quote">mlisp.wasm</span>.

The javascript file defines a <span class="single-quote">Module</span> that provides useful tool to access exported functions.


</div><h4>Let's start using it
</h4><div>
<pre class="triple-quote js">
const Mlisp = {
    init: Module.cwrap('mlisp_init', 'number', []),
    interpret: Module.cwrap('mlisp_interpret', 'string', ['string']),
    cleanup: Module.cwrap('mlisp_cleanup', 'void', []),
};

// Init interpreter
Mlisp.init();

// Run some commands
console.log(Mlisp.interpret("+ 2 2"));

// Cleanup interpreter
Mlisp.cleanup();
</pre>


</div><h3>Automated Build &amp; Release from github
</h3><div>
I made a github workflow for this project to automatically build and release so you can retrieve them from <a href="https://github.com/mliezun/mlisp/releases/tag/refs%2Fheads%2Fmaster">Github</a>.



</div><h3>REPL
</h3><div>
<script src="/assets/mlisp/mlisp.js"></script>

<style>
.container-centered {
  display: flex;
  justify-content: center;
}

.vertical-centered {
  display: block;
}
</style>

<div class="container-centered">
    <div class="vertical-centered" style="width: 40vw">
        <textarea id="show-repl" disabled="true" style="min-width: 40vw; max-width: 40vw; min-height: 20vh"></textarea>
        <input id="input-command" type="text" style="min-width: 40vw; max-width: 40vw" placeholder="&gt; Input some commands"/>
    </div>
</div>

<script type="application/javascript">
var A = {
    mlisp: null,
    init () {
        const node = document.getElementById('input-command');
        node.addEventListener("keyup", (event) => {
            if (event.key === "Enter") {
                this.handleInput(event);
            }
        });
    },
    handleInput(ev) {
        if (!this.mlisp) {
            window.Mlisp = {
                init: Module.cwrap('mlisp_init', 'number', []),
                interpret: Module.cwrap('mlisp_interpret', 'string', ['string']),
                cleanup: Module.cwrap('mlisp_cleanup', 'void', []),
            };
            this.mlisp = window.Mlisp;
            this.mlisp.init();
        }
        const node = ev.target;
        const cmd = node.value;
        if (!cmd) {
            return;
        }
        const output = document.getElementById('show-repl');
        const result = this.mlisp.interpret(cmd);
        node.value = null;
        output.value += `&gt; ${cmd}\n\t${result}\n`;
    }
};

A.init();
</script>




</div><h3>Interesting commands to try out
</h3><div>
<li><span class="single-quote">foldl</span>: Fold left (same as reduce left)
    - <span class="single-quote">(foldl + 0 {1 2 3 4 5})</span>: Sum of elements</li>
<li><span class="single-quote">filter</span>
    - <span class="single-quote">(filter (\ {e} {> e 3}) {1 2 3 4 5 6})</span>: Elements bigger than 3</li>
<li><span class="single-quote">map</span>
    - <span class="single-quote">(foldl * 1 (map (\ {e} {* e 2}) {1 1 1 1 1}))</span>: Multiply elements by 2 and then multiply all elements</li>


</div></article><footer><hr/><div class="footer-wrapper"><div><div>This blog was made with 
<a target="_blank" href="https://github.com/mliezun/grotsky">Grotsky</a></div><div>Blog
<a target="_blank" href="https://github.com/mliezun/mliezun.com">source code</a></div></div><div class="footer-socials"><a target="_blank" href="https://mliezun.com/feed.xml"><img alt="RSS Feed" src="/assets/images/socials/rss.png" width="20" height="20" style="border-radius: 3px"/></a><a target="_blank" href="https://github.com/mliezun"><img alt="Github" src="/assets/images/socials/github.png" width="20" height="20"/></a><a target="_blank" href="https://x.com/migueliezun"><img alt="X (Twitter)" src="/assets/images/socials/x.ico" width="20" height="20" style="border-radius: 5px"/></a><a target="_blank" href="https://www.linkedin.com/in/miguel-liezun-8697a9168/"><img alt="LinkedIn" src="/assets/images/socials/linkedin.png" width="20" height="20"/></a></div></div></footer></div></div><script src="/assets/js/theme-switcher.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/atom-one-dark.min.css"/><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script><script>document.querySelectorAll('.triple-quote').forEach(function (el) {
                    if (el.classList.length > 1) hljs.highlightElement(el, {language: el.classList[1]});
                    else hljs.highlightElement(el);
                    el.classList.remove('hljs');
                })
</script><script>document.querySelectorAll('.single-quote').forEach(function (el) {
                    if (el.classList.length > 1) hljs.highlightElement(el, {language: el.classList[1]});
                    else hljs.highlightElement(el);
                    el.classList.remove('hljs');
                })
</script></body></html>